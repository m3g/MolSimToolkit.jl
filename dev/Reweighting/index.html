<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>∘ Simulation Reweighting · MolSimToolkit.jl</title><meta name="title" content="∘ Simulation Reweighting · MolSimToolkit.jl"/><meta property="og:title" content="∘ Simulation Reweighting · MolSimToolkit.jl"/><meta property="twitter:title" content="∘ Simulation Reweighting · MolSimToolkit.jl"/><meta name="description" content="Documentation for MolSimToolkit.jl."/><meta property="og:description" content="Documentation for MolSimToolkit.jl."/><meta property="twitter:description" content="Documentation for MolSimToolkit.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="MolSimToolkit.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">MolSimToolkit.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../system_setup/">System setup</a></li><li><a class="tocitem" href="../molecular_minimum_distances/">Molecular Minimum Distances</a></li><li><a class="tocitem" href="../block_averages/">Block averages</a></li><li><a class="tocitem" href="../remd/">Replica exchange</a></li><li><a class="tocitem" href="../procrustes/">Structural alignment</a></li><li><a class="tocitem" href="../secondary_structures/">Secondary structure</a></li><li><a class="tocitem" href="../miscelaneous/">Miscelaneous functions</a></li><li><a class="tocitem" href="../Developer/">Developer zone</a></li><li><a class="tocitem" href="../plotting_style/">Plotting style</a></li><li><a class="tocitem" href="../Experimental/">Experimental</a></li><li><a class="tocitem" href="../Dihedrals/">∘ Dihedral angle analysis</a></li><li class="is-active"><a class="tocitem" href>∘ Simulation Reweighting</a><ul class="internal"><li><a class="tocitem" href="#How-to-use-it"><span>How to use it</span></a></li><li><a class="tocitem" href="#Setting-initial-parameters"><span>Setting initial parameters</span></a></li><li><a class="tocitem" href="#Setting-perturbation-function"><span>Setting perturbation function</span></a></li><li><a class="tocitem" href="#Computing-the-new-weights"><span>Computing the new weights</span></a></li><li><a class="tocitem" href="#Reference-Functions"><span>Reference Functions</span></a></li></ul></li><li><a class="tocitem" href="../Coaraci/">∘ Cluster submission management</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>∘ Simulation Reweighting</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>∘ Simulation Reweighting</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/m3g/MolSimToolkit.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/m3g/MolSimToolkit.jl/blob/main/docs/src/Reweighting.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="simulation_reweighting"><a class="docs-heading-anchor" href="#simulation_reweighting">Simulation Reweighting</a><a id="simulation_reweighting-1"></a><a class="docs-heading-anchor-permalink" href="#simulation_reweighting" title="Permalink"></a></h1><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>This is an experimental feature. Breaking changes may occur without  a breaking package release.</p></div></div><p>Computes the new weight for a frame of a simulation based on the energy difference between the perturbed and non-perturbed original sampling</p><p>This resource is based on the Free Energy Perturbation Theory (FEP) in the Molecular Dynamics context. Most of the time, each frame will contribute equally for calculations of some thermodynamic property, however, we can apply a perturbation on one or multiple types of atomic interactions (e.g. making water oxygen and protein carbonyl oxygen interaction more repulsive), making these frames to have different normalized statistical contributions so that we can  possibly preview the outcome of a new simulation with these modifications.</p><h2 id="How-to-use-it"><a class="docs-heading-anchor" href="#How-to-use-it">How to use it</a><a id="How-to-use-it-1"></a><a class="docs-heading-anchor-permalink" href="#How-to-use-it" title="Permalink"></a></h2><pre><code class="language-julia-repl hljs">julia&gt; using MolSimToolkit</code></pre><h2 id="Setting-initial-parameters"><a class="docs-heading-anchor" href="#Setting-initial-parameters">Setting initial parameters</a><a id="Setting-initial-parameters-1"></a><a class="docs-heading-anchor-permalink" href="#Setting-initial-parameters" title="Permalink"></a></h2><p>Firstly, we define the <code>simulation</code> object and set the atoms that will determine which interactions will be perturbed:</p><pre><code class="language-julia-repl hljs">julia&gt; using MolSimToolkit, PDBTools

julia&gt; testdir = &quot;$(@__DIR__)/test&quot;
&quot;/home/lucasv/.julia/dev/MolSimToolkit/src/Reweighting/test&quot;

julia&gt; simulation = Simulation(&quot;$testdir/Testing_reweighting.pdb&quot;, &quot;/$testdir/Testing_reweighting_10_frames_trajectory.xtc&quot;)
Simulation 
    Atom type: PDBTools.Atom
    PDB file: /home/lucasv/.julia/dev/MolSimToolkit/src/Resampling/test/Testing_resampling.pdb
    Trajectory file: /home/lucasv/.julia/dev/MolSimToolkit/src/Resampling/test/Testing_reweighting_10_frames_trajectory.xtc
    Total number of frames: 10
    Frame range: 1:1:10
    Number of frames in range: 10
    Current frame: nothing

julia&gt; i1 = PDBTools.selindex(atoms(simulation), &quot;resname TFE and name O&quot;)

julia&gt; i2 = PDBTools.selindex(atoms(simulation), &quot;protein and name O&quot;)</code></pre><h2 id="Setting-perturbation-function"><a class="docs-heading-anchor" href="#Setting-perturbation-function">Setting perturbation function</a><a id="Setting-perturbation-function-1"></a><a class="docs-heading-anchor-permalink" href="#Setting-perturbation-function" title="Permalink"></a></h2><p>In order to obtain these weights, we have to use two functions: the <code>reweight</code> function, which will calculate each weight and the <code>perturbation</code> function, responsible for taking each computed distance between atomic pairs in every frame and determine the resulting energy using these distances in that particular frame based on the applied perturbation.</p><p>So, secondly, we define some &quot;perturbation&quot; function (here we call it <code>gaussian decay</code>) and set up its parameters. Please, take a look at the interface:</p><pre><code class="language-julia-repl hljs">julia&gt; gaussian_decay(r, α, β) = α*exp(-abs(β)*r^2)
gaussian_decay (generic function with 1 method)

julia&gt; α = 5.e-3
0.005

julia&gt; β = 5.e-3
0.005</code></pre><p>As it can be seen, the function has to receive two parameters: <code>r</code> which corresponds to the distance between two selected atoms and some parameter to account a modification and change its magnitude, here, we inserted two of them in the same function, <code>α</code>, to change the maximum value of the gaussian curve and <code>β</code>, to adjust its decay behaviour with a given value of <code>r</code>.</p><h2 id="Computing-the-new-weights"><a class="docs-heading-anchor" href="#Computing-the-new-weights">Computing the new weights</a><a id="Computing-the-new-weights-1"></a><a class="docs-heading-anchor-permalink" href="#Computing-the-new-weights" title="Permalink"></a></h2><p>Finally, using the <code>reweight</code> function, we pass both the <code>simulation</code> and the last function anonymously in the input. Again, watch the interface:</p><pre><code class="language-julia-repl hljs">julia&gt; cut_off = 12.0
12.0

julia&gt; weights = reweight(simulation, (i,j,r) -&gt; gaussian_decay(r, α, β), i1, i2; cutoff = cut_off)</code></pre><p><code>i and j</code>: if you selected two atom types, <code>i</code> will be the index for either the first, the second, the third and so on up to the last atom of the first group and <code>j</code> will be same, but now for the second one. With these two parameters, it is possible to determine every combination of two atoms, each one coming from one group, and compute the associated dsitance <code>r</code>, so that we are taking into account all interactions between these two atom types to our perturbation. However, if we are dealing with just one group, both of them are indexes for all the atoms of the selected group. Bear in mind that repeated combinations (like <code>i,j = 1,2 or 2,1</code>) will no be computed, since the <code>reweight</code> function calls the <code>map_pairwise!</code> function, from <a href="https://github.com/m3g/CellListMap.jl">CellListMap.jl</a> that is able to avoid this problem.</p><p><code>r</code>: the distance between the twos atoms with indexes <code>i</code> and <code>j</code> in the selected groups.</p><p><code>cutoff</code>: the maximum distance that will be computed between two atoms. The default value is <code>12.0</code> Angstrom.</p><p>Once the calculations are finished, the resulted interface is shown, like the example below:</p><pre><code class="language-julia-repl hljs">-------------
FRAME WEIGHTS
-------------

Average probability = 0.09999999999999999
standard deviation = 0.01734935311311546

-------------------------------------------
FRAME WEIGHTS RELATIVE TO THE ORIGINAL ONES
-------------------------------------------

Average probability = 0.45655722352062866
standard deviation = 0.0792097248720297

----------------------------------
COMPUTED ENERGY AFTER PERTURBATION
----------------------------------

Average energy = 0.7973733879299723
standard deviation = 0.17177116838361012</code></pre><p>The data in <code>weights</code> structure is organized as it follows:</p><pre><code class="language-julia hljs">struct ReweightResults{T&lt;:Real}
    probability::Vector{T}
    relative_probability::Vector{T}
    energy::Vector{T}
end</code></pre><p>As an example, if we want the absolute weights computed for our simulation:</p><pre><code class="language-julia-repl hljs">julia&gt; weights.probability
10-element Vector{Float64}:
 0.08987791339898044
 0.07326337222373071
 0.0973116226496827
 0.10965810145525891
 0.09829891590498603
 0.0916792371461855
 0.08548699059703141
 0.12480704633057726
 0.09973413264337352
 0.12988266765019355</code></pre><h2 id="Reference-Functions"><a class="docs-heading-anchor" href="#Reference-Functions">Reference Functions</a><a id="Reference-Functions-1"></a><a class="docs-heading-anchor-permalink" href="#Reference-Functions" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="MolSimToolkit.Reweighting.reweight-Tuple{Simulation, Function, AbstractVector{&lt;:Integer}}" href="#MolSimToolkit.Reweighting.reweight-Tuple{Simulation, Function, AbstractVector{&lt;:Integer}}"><code>MolSimToolkit.Reweighting.reweight</code></a> — <span class="docstring-category">Method</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">reweight(
    simulation::Simulation, 
    f_perturbation::Function, 
    group_1::AbstractVector{&lt;:Integer}; 
    cutoff::Real = 12.0, 
    k::Real = 1.0, 
    T::Real = 1.0
)
reweight(
    simulation::Simulation, 
    f_perturbation::Function, 
    group_1::AbstractVector{&lt;:Integer}, 
    group_2::AbstractVector{&lt;:Integer};     
    cutoff::Real = 12.0, 
    k::Real = 1.0, 
    T::Real = 1.0
)</code></pre><p>Function that calculates the energy difference when a perturbation is applied on the system.</p><p>It returns &quot;ReweightResults&quot; structure that contains three results: <code>probability</code>, <code>relative_probability</code> and <code>energy</code> vectors.</p><p>The function needs a MolSimToolkit&#39;s simulation object, another function to compute the perturbation and one or two types of atoms.</p><p>Additionally, you can also define a cutoff distance, the constant &quot;k&quot; (in some cases, it will be Boltzmann constant) and the temperature, T, of the system.</p><p>Group<em>1 (and group</em>2) is a vector of atoms indexes, extracted, for example, from a pdb file. </p><p><strong>Example</strong></p><pre><code class="language-julia-repl hljs">julia&gt; import PDBTools

julia&gt; using MolSimToolkit, MolSimToolkit.Resampling

julia&gt; simulation = Simulation(&quot;/home/runner/work/MolSimToolkit.jl/MolSimToolkit.jl/src/Reweighting/test/Testing_reweighting.pdb&quot;, &quot;//home/runner/work/MolSimToolkit.jl/MolSimToolkit.jl/src/Reweighting/test/Testing_reweighting_10_frames_trajectory.xtc&quot;)
Simulation 
    Atom type: Atom
    PDB file: /home/lucasv/.julia/dev/MolSimToolkit/src/Reweighting/test/Testing_reweighting.pdb
    Trajectory file: /home/lucasv/.julia/dev/MolSimToolkit/src/Resampling/test/Testing_reweighting_10_frames_trajectory.xtc
    Total number of frames: 10
    Frame range: 1:1:10
    Number of frames in range: 10
    Current frame: nothing

julia&gt; i1 = PDBTools.selindex(atoms(simulation), &quot;index 97 or index 106&quot;)
2-element AbstractVector{&lt;:Integer}:
  97
 106

julia&gt; i2 = PDBTools.selindex(atoms(simulation), &quot;residue 15 and name HB3&quot;)
1-element AbstractVector{&lt;:Integer}:
 171

julia&gt; sum_of_dist = reweight(simulation, (i,j,d2) -&gt; d2, i1, i2; cutoff = 25.0)
-------------
FRAME WEIGHTS
-------------

Average probability = 0.1
standard deviation = 0.011364584999859616

-------------------------------------------
FRAME WEIGHTS RELATIVE TO THE ORIGINAL ONES
-------------------------------------------

Average probability = 0.6001821184861403
standard deviation = 0.06820820700931557

----------------------------------
COMPUTED ENERGY AFTER PERTURBATION
----------------------------------

Average energy = 0.5163045415662408
standard deviation = 0.11331912115883522

julia&gt; sum_of_dist.energy
10-element Vector{Real}:
 17.738965476707595
 15.923698293115915
 17.16614676290554
 19.33003841107648
 16.02329229247863
 19.639005665480983
 35.73986006775934
 21.88798265022823
 20.66180657974777
 16.845109623700647

This result is the energy difference between the  perturbed frame and the original one. In this case, it is the sum of distances between the reffered atoms</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/m3g/MolSimToolkit.jl/blob/8e15b6031caee5c3214623b4ab0c827f27ac8e18/src/Reweighting/Reweight.jl#L16-L108">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="MolSimToolkit.Reweighting.ReweightResults" href="#MolSimToolkit.Reweighting.ReweightResults"><code>MolSimToolkit.Reweighting.ReweightResults</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><p>Structure that contains the result of the reweighting analysis of the sequence. </p><p><code>probability</code> is a vector that contains the normalized weight of each frame in the simulation after applying some perturbation. </p><p><code>relative_probability</code> is a vector that contains the weight of each frame in the simulation relative to the original one after applying some perturbation.</p><p><code>energy</code> is a vector that contains the energy difference for each frame in the simulation after applying some perturbation.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/m3g/MolSimToolkit.jl/blob/8e15b6031caee5c3214623b4ab0c827f27ac8e18/src/Reweighting/Reweight.jl#L1-L9">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../Dihedrals/">« ∘ Dihedral angle analysis</a><a class="docs-footer-nextpage" href="../Coaraci/">∘ Cluster submission management »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.0 on <span class="colophon-date" title="Monday 10 February 2025 20:31">Monday 10 February 2025</span>. Using Julia version 1.10.8.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
